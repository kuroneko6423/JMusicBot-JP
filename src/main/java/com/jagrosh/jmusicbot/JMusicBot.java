/*
 * Copyright 2016 John Grosh (jagrosh).
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.jagrosh.jmusicbot;

import com.github.lalyos.jfiglet.FigletFont;
import com.jagrosh.jdautilities.command.Command;
import com.jagrosh.jdautilities.command.CommandClientBuilder;
import com.jagrosh.jdautilities.command.SlashCommand;
import com.jagrosh.jdautilities.commons.waiter.EventWaiter;
import com.jagrosh.jmusicbot.entities.Prompt;
import com.jagrosh.jmusicbot.gui.GUI;
import com.jagrosh.jmusicbot.settings.SettingsManager;
import com.jagrosh.jmusicbot.utils.OtherUtil;
import dev.cosgy.JMusicBot.slashcommands.admin.*;
import dev.cosgy.JMusicBot.slashcommands.dj.*;
import dev.cosgy.JMusicBot.slashcommands.general.*;
import dev.cosgy.JMusicBot.slashcommands.listeners.CommandAudit;
import dev.cosgy.JMusicBot.slashcommands.music.*;
import dev.cosgy.JMusicBot.slashcommands.owner.*;
import net.dv8tion.jda.api.JDA;
import net.dv8tion.jda.api.JDABuilder;
import net.dv8tion.jda.api.OnlineStatus;
import net.dv8tion.jda.api.Permission;
import net.dv8tion.jda.api.entities.Activity;
import net.dv8tion.jda.api.requests.GatewayIntent;
import net.dv8tion.jda.api.utils.cache.CacheFlag;
import org.slf4j.Logger;

import javax.security.auth.login.LoginException;
import java.awt.*;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import static org.slf4j.LoggerFactory.getLogger;

/**
 * @author John Grosh (jagrosh)
 */
public class JMusicBot {
    public final static String PLAY_EMOJI = "\u25B6"; // ‚ñ∂
    public final static String PAUSE_EMOJI = "\u23F8"; // ‚è∏
    public final static String STOP_EMOJI = "\u23F9"; // ‚èπ
    public final static Permission[] RECOMMENDED_PERMS = {Permission.MESSAGE_READ, Permission.MESSAGE_WRITE, Permission.MESSAGE_HISTORY, Permission.MESSAGE_ADD_REACTION,
            Permission.MESSAGE_EMBED_LINKS, Permission.MESSAGE_ATTACH_FILES, Permission.MESSAGE_MANAGE, Permission.MESSAGE_EXT_EMOJI,
            Permission.MANAGE_CHANNEL, Permission.VOICE_CONNECT, Permission.VOICE_SPEAK, Permission.NICKNAME_CHANGE};
    public final static GatewayIntent[] INTENTS = {GatewayIntent.DIRECT_MESSAGES, GatewayIntent.GUILD_MESSAGES, GatewayIntent.GUILD_MESSAGE_REACTIONS, GatewayIntent.GUILD_VOICE_STATES};
//    public static boolean CHECK_UPDATE = false;
    public static boolean COMMAND_AUDIT_ENABLED = false;

    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) {
        // startup log
        Logger log = getLogger("Startup");

//        try {
//            System.out.println(FigletFont.convertOneLine("JMusicBot v" + OtherUtil.getCurrentVersion()) + "\n" + "by Cosgy Dev");
//        } catch (IOException e) {
//            System.out.println("JMusicBot v" + OtherUtil.getCurrentVersion() + "\nby Cosgy Dev");
//        }


        // create prompt to handle startup
        Prompt prompt = new Prompt("JMusicBot", "nogui„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ  -Dnogui=true„Éï„É©„Ç∞„ÇíÂê´„ÇÅ„Çã„Å®„ÄÅÊâãÂãï„Åßnogui„É¢„Éº„Éâ„ÅßËµ∑Âãï„Åß„Åç„Åæ„Åô„ÄÇ");

        // check deprecated nogui mode (new way of setting it is -Dnogui=true)
        for (String arg : args)
            if ("-nogui".equalsIgnoreCase(arg)) {
                prompt.alert(Prompt.Level.WARNING, "GUI", "-nogui„Éï„É©„Ç∞„ÅØÂªÉÊ≠¢‰∫àÂÆö„Åß„Åô„ÄÇ "
                        + "jar„ÅÆÂêçÂâç„ÅÆÂâç„Å´-Dnogui = true„Éï„É©„Ç∞„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ ‰æãÔºöjava -jar -Dnogui=true JMusicBot.jar");
//            } else if ("-nocheckupdates".equalsIgnoreCase(arg)) {
//                CHECK_UPDATE = false;
//                log.info("„Ç¢„ÉÉ„Éó„Éá„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁÑ°Âäπ„Å´„Åó„Åæ„Åó„Åü");
            } else if ("-auditcommands".equalsIgnoreCase(arg)) {
                COMMAND_AUDIT_ENABLED = true;
                log.info("ÂÆüË°å„Åï„Çå„Åü„Ç≥„Éû„É≥„Éâ„ÅÆË®òÈå≤„ÇíÊúâÂäπ„Å´„Åó„Åæ„Åó„Åü„ÄÇ");
            }

        if (!System.getProperty("java.vm.name").contains("64"))
            prompt.alert(Prompt.Level.WARNING, "Java Version", "„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑJava„Éê„Éº„Ç∏„Éß„É≥„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ64„Éì„ÉÉ„ÉàÁâà„ÅÆJava„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");

        // load config
        BotConfig config = new BotConfig(prompt);
        config.load();
        if (!config.isValid())
            return;

        if (config.getAuditCommands()) {
            COMMAND_AUDIT_ENABLED = true;
            log.info("ÂÆüË°å„Åï„Çå„Åü„Ç≥„Éû„É≥„Éâ„ÅÆË®òÈå≤„ÇíÊúâÂäπ„Å´„Åó„Åæ„Åó„Åü„ÄÇ");
        }

        // set up the listener
        EventWaiter waiter = new EventWaiter();
        SettingsManager settings = new SettingsManager();
        Bot bot = new Bot(waiter, config, settings);
        Bot.INSTANCE = bot;

        AboutCommand aboutCommand = new AboutCommand(bot);
        aboutCommand.setIsAuthor(false);
        aboutCommand.setReplacementCharacter("\uD83C\uDFB6"); // üé∂

        // set up the command client
        CommandClientBuilder cb = new CommandClientBuilder()
                .setPrefix(config.getPrefix())
                .setAlternativePrefix(config.getAltPrefix())
                .setOwnerId(Long.toString(config.getOwnerId()))
                .setEmojis(config.getSuccess(), config.getWarning(), config.getError())
                .setHelpWord(config.getHelp())
                .setLinkedCacheSize(200)
                .setGuildSettingsManager(settings)
                .setListener(new CommandAudit())
                .setHelpConsumer((event) -> {
                    new HelpCmd().execute(event);
                });

        if (config.isOfficialInvite()) {
            cb.setServerInvite("https://discord.gg/MjNfC6TK2y");
        }

        List<Command> commandList = new ArrayList<Command>() {{
            //„Åù„ÅÆ‰ªñ
            add(aboutCommand);
            add(new InviteCommand());
            add(new PingCommand());
            add(new SettingsCmd(bot));
            if (config.getCosgyDevHost()) add(new InfoCommand(bot));
            // General
            add(new ServerInfo());
            //add(new UserInfo());
            add(new CashCmd(bot));
            // Music
            add(new LyricsCmd(bot));
            add(new NowplayingCmd(bot));
            add(new PlayCmd(bot));
            add(new PlaylistsCmd(bot));
            add(new MylistCmd(bot));
            //add(new QueueCmd(bot));
            add(new QueueCmd(bot));
            add(new RemoveCmd(bot));
            add(new SearchCmd(bot));
            add(new SCSearchCmd(bot));
            add(new NicoSearchCmd(bot));
            add(new ShuffleCmd(bot));
            add(new SkipCmd(bot));
            add(new VolumeCmd(bot));
            // DJ
            add(new ForceRemoveCmd(bot));
            add(new ForceskipCmd(bot));
            add(new NextCmd(bot));
            add(new MoveTrackCmd(bot));
            add(new PauseCmd(bot));
            add(new PlaynextCmd(bot));
            //add(new RepeatCmd(bot));
            add(new RepeatCmd(bot));
            add(new SkipToCmd(bot));
            add(new PlaylistCmd(bot));
            add(new StopCmd(bot));
            //add(new VolumeCmd(bot));
            // Admin
            add(new PrefixCmd(bot));
            add(new SetdjCmd(bot));
            add(new SettcCmd(bot));
            add(new SetvcCmd(bot));
            add(new AutoplaylistCmd(bot));
            // Owner
            add(new DebugCmd(bot));
            add(new SetavatarCmd(bot));
            add(new SetgameCmd(bot));
            add(new SetnameCmd(bot));
            add(new SetstatusCmd(bot));
            add(new PublistCmd(bot));
            add(new ShutdownCmd(bot));
        }};

        cb.addCommands(commandList.toArray(new Command[0]));

        // „Çπ„É©„ÉÉ„Ç∑„É•„Ç≥„Éû„É≥„Éâ„ÅÆÂÆüË£Ö
        List<SlashCommand> slashCommandList = new ArrayList<SlashCommand>() {{
            add(aboutCommand);
            add(new InviteCommand());
            add(new PingCommand());
            add(new SettingsCmd(bot));
            if (config.getCosgyDevHost()) add(new InfoCommand(bot));
            // General
            add(new ServerInfo());
            //add(new UserInfo());
            add(new CashCmd(bot));
            // Music
            add(new LyricsCmd(bot));
            add(new NowplayingCmd(bot));
            add(new PlayCmd(bot));
            add(new PlaylistsCmd(bot));
            add(new MylistCmd(bot));
            //add(new QueueCmd(bot));
            add(new QueueCmd(bot));
            add(new RemoveCmd(bot));
            add(new SearchCmd(bot));
            add(new SCSearchCmd(bot));
            add(new NicoSearchCmd(bot));
            add(new ShuffleCmd(bot));
            add(new SkipCmd(bot));
            add(new VolumeCmd(bot));
            // DJ
            add(new ForceRemoveCmd(bot));
            add(new ForceskipCmd(bot));
            add(new NextCmd(bot));
            add(new MoveTrackCmd(bot));
            add(new PauseCmd(bot));
            add(new PlaynextCmd(bot));
            //add(new RepeatCmd(bot));
            add(new RepeatCmd(bot));
            add(new SkipToCmd(bot));
            add(new PlaylistCmd(bot));
            add(new StopCmd(bot));
            //add(new VolumeCmd(bot));
            // Admin
            add(new PrefixCmd(bot));
            add(new SetdjCmd(bot));
            add(new SettcCmd(bot));
            add(new SetvcCmd(bot));
            add(new AutoplaylistCmd(bot));
            // Owner
            add(new DebugCmd(bot));
            add(new SetavatarCmd(bot));
            add(new SetgameCmd(bot));
            add(new SetnameCmd(bot));
            add(new SetstatusCmd(bot));
            add(new PublistCmd(bot));
            add(new ShutdownCmd(bot));
        }};

        cb.addSlashCommands(slashCommandList.toArray(new SlashCommand[0]));

        if (config.useEval())
            cb.addCommand(new EvalCmd(bot));
        boolean nogame = false;
        if (config.getStatus() != OnlineStatus.UNKNOWN)
            cb.setStatus(config.getStatus());
        cb.setActivity(Activity.playing("Loading..."));
        if (!prompt.isNoGUI()) {
            try {
                GUI gui = new GUI(bot);
                bot.setGUI(gui);
                gui.init();
            } catch (Exception e) {
                log.error("GUI„ÇíÈñã„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÊ¨°„ÅÆË¶ÅÂõ†„ÅåËÄÉ„Åà„Çâ„Çå„Åæ„Åô:\n"
                        + "„Çµ„Éº„Éê„Éº‰∏ä„ÅßÂÆüË°å„Åó„Å¶„ÅÑ„Çã\n"
                        + "ÁîªÈù¢„Åå„Å™„ÅÑÁí∞Â¢É‰∏ã„ÅßÂÆüË°å„Åó„Å¶„ÅÑ„Çã\n"
                        + "„Åì„ÅÆ„Ç®„É©„Éº„ÇíÈùûË°®Á§∫„Å´„Åô„Çã„Å´„ÅØ„ÄÅ -Dnogui=true „Éï„É©„Ç∞„Çí‰ΩøÁî®„Åó„Å¶GUI„Å™„Åó„É¢„Éº„Éâ„ÅßÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        }

        log.info(config.getConfigLocation() + " „Åã„ÇâË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü");

        // attempt to log in and start
        try {
            JDA jda = JDABuilder.create(config.getToken(), Arrays.asList(INTENTS))
                    .enableCache(CacheFlag.MEMBER_OVERRIDES, CacheFlag.VOICE_STATE)
                    .disableCache(CacheFlag.ACTIVITY, CacheFlag.CLIENT_STATUS, CacheFlag.EMOTE, CacheFlag.ONLINE_STATUS)
                    .setActivity(nogame ? null : Activity.playing("„É≠„Éº„Éâ‰∏≠..."))
                    .setStatus(config.getStatus() == OnlineStatus.INVISIBLE || config.getStatus() == OnlineStatus.OFFLINE
                            ? OnlineStatus.INVISIBLE : OnlineStatus.DO_NOT_DISTURB)
                    .addEventListeners(cb.build(), waiter, new Listener(bot))
                    .setBulkDeleteSplittingEnabled(true)
                    .build();
            bot.setJDA(jda);
        } catch (LoginException ex) {
            prompt.alert(Prompt.Level.ERROR, "JMusicBot", ex + "\n" +
                    "Ê≠£„Åó„ÅÑË®≠ÂÆö„Éï„Ç°„Ç§„É´„ÇíÁ∑®ÈõÜ„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇBot„Éà„Éº„ÇØ„É≥„Åß„ÅÆ„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ" +
                    "Ê≠£„Åó„ÅÑBot„Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ(CLIENT SECRET „Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì!)\n" +
                    "Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆÂ†¥ÊâÄ: " + config.getConfigLocation());
            System.exit(1);
        } catch (IllegalArgumentException ex) {
            prompt.alert(Prompt.Level.ERROR, "JMusicBot", "Ë®≠ÂÆö„ÅÆ‰∏ÄÈÉ®„ÅåÁÑ°Âäπ„Åß„Åô:" + ex + "\n" +
                    "Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆÂ†¥ÊâÄ: " + config.getConfigLocation());
            System.exit(1);
        }
    }
}
